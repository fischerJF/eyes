<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="./assets/img/index">

    <title>Visualização de Dados</title>

    <link href="./assets/css/basics.css" rel="stylesheet">

    <link href="./vendors/css/bootstrap.min.css" rel="stylesheet">

    <link href="./vendors/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <link href="./vendors/css/starter-template.css" rel="stylesheet">

    <script src="./vendors/js/ie-emulation-modes-warning.js"></script>

    <link rel="stylesheet" type="text/css" href="./assets/css/tooltip.css"/>

    <style>

      body {
        font: 10px sans-serif;
      }

      .axis line,
      .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .arrow {
        stroke: #000;
        stroke-width: 1.5px;
      }

      .outer,
      .inner {
        shape-rendering: crispEdges;
      }

      .outer {
        fill: none;
        stroke: #000;
      }

      .inner {
        fill: #ccc;
        stroke: #000;
        stroke-dasharray: 3, 4;
      }

    </style>

  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Flowers</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="starter-template">
        <h1>TP2 - Visualização com D3</h1>
      </div>
    </div>

    <!-- Import D3 -->
    <!-- <script src="./vendors/js/d3.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="./vendors/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="./vendors/js/bootstrap.min.js"></script>
    <script src="./vendors/js/ie10-viewport-bug-workaround.js"></script>
    <!-- <script type='text/javascript' src='./assets/js/jquery-1.6.1.min.js'></script> -->
    <script type='text/javascript' src='./assets/js/tooltip.js'></script>
    <!-- Custom JavaScript-->
    <!-- <script src="./assets/js/scatter.js"></script> -->

    <script>
      // debug
      var debug; 

      // svg limits 
      var margin // {top, right, bottom, left}
        , width
        , height;

      // chart scale attributes
      var x
        , y;

      // colors
      var color;

      // coordinate constructors
      var xAxis
        , yAxis;

      // main canvas
      var svg;

      // data
      var data // data about the countries
        , countries // lang data
        , data_ // processed data about countries 
        , countries_; // processed data about different names

      // flower attributes
      var radius; // max radius value

      function init() {
        margin = {top: 20, right: 50, bottom: 30, left: 50};
        width = window.innerWidth - margin.left - margin.right;
        height = (window.innerHeight/1.5) - margin.top - margin.bottom;
        // width = 1200 - margin.left - margin.right;
        // height = 550 - margin.top - margin.bottom;

        x = d3.scaleBand()
          .rangeRound([0, width]);


        y = d3.scaleLinear().range([height, 0]);

        color = d3.scaleOrdinal(d3.schemeCategory10);;

        xAxis = d3.axisBottom(x);

        yAxis = d3.axisLeft(y);

        svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      }

      function buildAxis() {
        x.domain(data.map(function(d) { return d.country; }));

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        y.domain([0.0, 1.0]).nice();

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        radius = x.step()/2;
      }

      function avg(country) {
        var amountMetrics = Object.keys(data_[country]).length;
        return (data_[country]["housing"] 
              + data_[country]["income"]
              + data_[country]["jobs"]
              + data_[country]["community"]
              + data_[country]["education"]
              + data_[country]["environment"]
              + data_[country]["civic engagement"]
              + data_[country]["health"]
              + data_[country]["life satisfaction"]
              + data_[country]["safety"]
              + data_[country]["work life balance"]
              )/amountMetrics;
      }

      function processData() {
        data_ = {};
        data.forEach(function(d) {
          data_[d.country] = {};
          
          data_[d.country]["housing"] = +d.housing;                        // 1
          data_[d.country]["income"] = +d.income;                          // 2
          data_[d.country]["jobs"] = +d.jobs;                              // 3
          data_[d.country]["community"] = +d.community;                    // 4
          data_[d.country]["education"] = +d.education;                    // 5
          data_[d.country]["environment"] = +d.environment;                // 6
          data_[d.country]["civic engagement"] = +d["civic engagement"];   // 7
          data_[d.country]["health"] = +d["health"];                       // 8
          data_[d.country]["life satisfaction"] = +d["life satisfaction"]; // 9
          data_[d.country]["safety"] = +d.safety;                          // 10
          data_[d.country]["work life balance"] = +d["work-life balance"]; // 11

          data_[d.country]["avg"] = avg(d.country);
          data_[d.country]["cx"] = x(d.country)+x.step()/2;
          data_[d.country]["cy"] = y(data_[d.country]["avg"]);
        });

        countries_ = {};
        countries.forEach(function(d) {
          countries_[d.code] = {};
          countries_[d.code]["en"] = d.en;
          countries_[d.code]["fr"] = d.fr;
          countries_[d.code]["es"] = d.es;
          countries_[d.code]["ru"] = d.ru;
          countries_[d.code]["de"] = d.de;
          countries_[d.code]["pt"] = d.pt;
          countries_[d.code]["it"] = d.it;
        });
      }

      function insertFlowers() {

        var flowers = svg.selectAll(".flowers")
          .data(data)
          .enter()
          .append("g")
            .attr("class", "flowers");

        var line = flowers.append("line")
            .attr("x1", function(d) { return data_[d.country].cx; })
            .attr("y1", function(d) { return data_[d.country].cy; })
            .attr("x2", function(d) { return data_[d.country].cx; })
            .attr("y2", height)
            .attr("stroke-width", 1)
            .attr("stroke", "green");

        var labels = flowers.append("text")
            .attr("font-family", "arial")
            .attr("font-size", "12px")
            .attr("fill", "black") 
            .style("font-weight", "bold")
            .attr("transform", function(d) { 
              return ("translate("+(data_[d.country].cx - 2)
                +","+(data_[d.country].cy + 15)+")rotate(90)"); 
            })
            .text(function(d) { return countries_[d.country].pt;});

        var center = flowers.append("g")
            .attr("class", "flower")
            .attr("data-target", function(d) { return d.country; })
            // .attr("title", function(d) { return data_[d.country].cx; })
            .attr("rel", "tooltip")
            .append("circle")
            .attr("class", "dot")
            .attr("r", 2)
            .attr("cx", function(d) { return data_[d.country].cx; })
            .attr("cy", function(d) { return data_[d.country].cy; })
            .style("fill", function(d) { return color(d.country); });

        var metrics = ["housing", "income", "jobs", "community", "education", "environment", "civic engagement", "health", "life satisfaction", "safety", "work life balance"];

        metrics.forEach(function(m, i) {
          var theta = (i * (360/metrics.length)) * Math.PI / 180.0;
          flowers.selectAll(".flower").append("line")
            .attr("x1", function(d) { return data_[d.country].cx; })
            .attr("y1", function(d) { return data_[d.country].cy; })
            .attr("x2", function(d) { return (data_[d.country].cx + Math.cos(theta)*radius*data_[d.country][m]); })
            .attr("y2", function(d) { return (data_[d.country].cy + Math.sin(theta)*radius*data_[d.country][m]); })
            .attr("stroke-width", 2)
            .attr("stroke", function(d) { return color(m); })
            .attr("class", "petal")
            .attr("data-target", m.replace(/ /g, "-"))
            .on("mouseover", function(){
              d3.selectAll(".petal").attr("opacity", 0.4);
              var selector = '[data-target=' + d3.select(this).attr("data-target") + ']';
              $(selector).attr("opacity", 1);
            }).on("mouseout", function(){
              d3.selectAll(".petal").attr("opacity", 1);
            });
        });

      }

      function builVisualization() {
        debug = true;

        init();

        buildAxis();

        processData();

        insertFlowers();

        if (debug)
          console.log("end of builVisualization!");
      }
      
      d3.csv("./data/data.csv", function(error, inputData) {
          if (error) alert("Problema para ler os dados de entrada!");

          data = inputData;          

          d3.json("./data/countries.json", function(error2, json) {
            if (error2) alert("Problema para ler os dados sobre os países!");

            countries = json;

            builVisualization();

            tooltip(data_, Object.keys(data[0]), countries_);
          });
      });

      window.addEventListener('resize', function(){
        d3.select("svg").remove();
        builVisualization();
        tooltip(data_, Object.keys(data[0]), countries_);
      });


    </script>

  </body>
</html>
